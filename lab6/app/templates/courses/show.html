{% extends 'base.html' %}

{% block content %}
<div class="title-area position-relative" style="background-image: url({{ course.bg_image.url }});">
  <div class="h-100 w-100 py-5 d-flex text-center position-absolute" style="background-color: rgba(0, 0, 0, 0.65);">
    <div class="m-auto">
      <h1 class="title mb-3 font-weight-bold">{{ course.name }}</h1>
      <p class="mb-3 mx-auto">
        {{ course.category.name }} | <span>★</span> <span>{{ "%.2f" | format(course.rating) }}</span>
      </p>
      <div class="container">
        <p class="description w-75 mb-5 mx-auto">
          {{ course.short_desc }}
        </p>
      </div>

      {% if current_user.is_authenticated %}
        <a href="#" class="btn btn-outline-light btn-lg">Перейти к материалам курса</a>
      {% else %}
        <button class="btn btn-outline-light btn-lg" disabled>Записаться</button>
      {% endif %}
    </div>
  </div>
</div>

<div class="container mt-5">
  <section class="about mb-5">
    <h2 class="mb-3 text-center text-uppercase font-weight-bold">О курсе</h2>
    <p>{{ course.full_desc }}</p>
  </section>

  <section class="program mb-5">
    <h2 class="mb-3 text-center text-uppercase font-weight-bold">Программа курса</h2>

    {% for theme in course.themes %}
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center">
          <h5 class="mb-0">Тема {{ loop.index }}. {{ theme.name }}</h5>
          {% if current_user.is_authenticated and current_user.id == course.author_id %}
            <button class="btn btn-primary btn-sm ms-auto" title="Добавить пункт" data-parent-id="{{ theme.id }}">+</button>
          {% endif %}
        </div>
        <div class="card-body">
          {% set outer_loop = loop %}
          {% for subtheme in theme.subthemes %}
            <div class="d-flex align-items-center">
              <p class="card-text mb-3">{{ outer_loop.index }}.{{ loop.index }}. {{ subtheme.name }}</p>
              {% if current_user.is_authenticated and current_user.id == course.author_id %}
                <a href="#" class="btn btn-sm ms-auto" title="Добавить материал" data-parent-id="{{ theme.id }}">+</a>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    {% if current_user.is_authenticated and current_user.id == course.author_id %}
      <div class="text-center">
        <button type="button" class="btn btn-dark">
          Добавить тему
        </button>
      </div>
    {% endif %}
  </section>

  <!-- ОТЗЫВЫ -->
  <section class="reviews mb-5">
    <div class="d-flex align-items-center mb-3">
      <h2 class="text-center text-uppercase font-weight-bold m-0">Отзывы</h2>

      <!-- ВАЖНО: это рабочая ссылка, не # -->
      <a class="btn btn-outline-dark ms-auto" href="{{ url_for('courses.reviews', course_id=course.id) }}">
        Все отзывы
      </a>
    </div>

    {% if last_reviews and last_reviews|length > 0 %}
      {% for review in last_reviews %}
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <strong>{{ review.user.full_name }}</strong>
              <small class="text-muted ms-auto">{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>

            <div class="mb-2">
              {% for i in range(5) %}
                {% if i < review.rating %}★{% else %}☆{% endif %}
              {% endfor %}
              <span class="ms-2 text-muted">{{ review.rating }}/5</span>
            </div>

            <p class="mb-0">{{ review.text }}</p>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">Пока нет отзывов.</p>
    {% endif %}

    <hr class="my-4">

    <h3 class="mb-3">Оставить отзыв</h3>

    {% if current_user.is_authenticated %}
      {% if my_review %}
        <div class="alert alert-info">
          Вы уже оставили отзыв к этому курсу:
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <strong>{{ current_user.full_name }}</strong>
              <small class="text-muted ms-auto">{{ my_review.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>

            <div class="mb-2">
              {% for i in range(5) %}
                {% if i < my_review.rating %}★{% else %}☆{% endif %}
              {% endfor %}
              <span class="ms-2 text-muted">{{ my_review.rating }}/5</span>
            </div>

            <p class="mb-0">{{ my_review.text }}</p>
          </div>
        </div>
      {% else %}
        <form method="post" action="{{ url_for('courses.create_review', course_id=course.id) }}">
          <input type="hidden" name="next" value="{{ request.path }}">

          <div class="mb-3">
            <label class="form-label">Оценка</label>
            <select class="form-select" name="rating">
              <option value="5" selected>отлично</option>
              <option value="4">хорошо</option>
              <option value="3">удовлетворительно</option>
              <option value="2">плохо</option>
              <option value="1">очень плохо</option>
              <option value="0">ужасно</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Текст отзыва</label>
            <textarea class="form-control" name="text" rows="4" required></textarea>
          </div>

          <button class="btn btn-dark" type="submit">Отправить</button>
        </form>
      {% endif %}
    {% else %}
      <a class="btn btn-dark" href="{{ url_for('auth.login', next=request.full_path) }}">
        Войти, чтобы оставить отзыв
      </a>
    {% endif %}
  </section>
</div>
{% endblock %}
